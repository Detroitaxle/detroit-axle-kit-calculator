<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [Previous head content remains exactly the same] -->
</head>
<body>
  <!-- [Previous body content remains exactly the same until the script section] -->

  <script>
    const knownSingleItems = ["brake pads", "brake rotors"];
    let currentParts = [];
    let lastTotalRefund = 0;

    document.getElementById("kitInput").addEventListener("input", () => {
      processInput();
    });

    function showStatus(message, isError = false) {
      const statusEl = document.getElementById("statusMessage");
      statusEl.textContent = message;
      statusEl.className = `status-message ${isError ? 'error' : 'success'}`;
      
      setTimeout(() => {
        statusEl.className = "status-message";
      }, 5000);
    }

    function normalizeQuantity(desc, qty) {
      const descLower = desc.toLowerCase();
      if (knownSingleItems.some(part => descLower.includes(part))) {
        return 1;
      }
      if (descLower.includes("(pair)") && qty == 1) {
        return 2;
      }
      if (descLower.includes("pair of") && qty == 1) {
        return 2;
      }
      return qty;
    }

    function processInput() {
      const input = document.getElementById("kitInput").value.trim();
      if (!input) {
        document.getElementById("controls").style.display = "none";
        document.getElementById("tableContainer").innerHTML = "";
        document.getElementById("refundTotal").textContent = "";
        return;
      }

      const lines = input.split(/\n+/);
      currentParts = [];
      let parseSuccess = false;

      lines.forEach(line => {
        line = line.trim();
        if (!line) return;

        // Simple approach: first number is quantity, rest is description and part number
        const match = line.match(/^(\d+)x?\s+(.+)/i);
        if (match) {
          let qty = parseInt(match[1]);
          let remaining = match[2].trim();
          
          // Split into description and part number
          let desc, partNum;
          const lastSpaceIndex = remaining.lastIndexOf(' ');
          
          if (lastSpaceIndex > 0) {
            desc = remaining.substring(0, lastSpaceIndex).trim();
            partNum = remaining.substring(lastSpaceIndex + 1).trim();
          } else {
            desc = remaining;
            partNum = "";
          }
          
          qty = normalizeQuantity(desc, qty);
          currentParts.push({ qty, desc, partNum, price: 0, returned: 0 });
          parseSuccess = true;
        }
      });

      if (currentParts.length > 0) {
        document.getElementById("controls").style.display = "flex";
        renderTable(currentParts);
        if (!parseSuccess) {
          showStatus("Some lines couldn't be parsed. Please check your format.", true);
        } else {
          showStatus(`${currentParts.length} items detected`, false);
        }
      } else {
        document.getElementById("controls").style.display = "none";
        document.getElementById("tableContainer").innerHTML = "";
        document.getElementById("refundTotal").textContent = "";
        showStatus("No items detected. Please check your format.", true);
      }
    }

    function renderTable(parts) {
      let tableHTML = `
        <table>
          <thead>
            <tr>
              <th>Qty</th>
              <th class="part-desc">Description</th>
              <th>Part #</th>
              <th>Unit Price ($)</th>
              <th>Returned</th>
              <th>Refund ($)</th>
              <th>All</th>
            </tr>
          </thead>
          <tbody>
      `;

      parts.forEach((part, index) => {
        tableHTML += `
          <tr>
            <td><input type="number" value="${part.qty}" min="0" onchange="updateQty(${index})" id="qty-${index}"></td>
            <td class="part-desc">${part.desc}</td>
            <td>${part.partNum ? `<span class="part-number">${part.partNum}</span>` : '-'}</td>
            <td><input type="number" value="${part.price || ''}" min="0" step="0.01" onchange="updatePrice(${index})" onfocus="clearZero(this)" id="price-${index}" placeholder="0.00"></td>
            <td><input type="number" value="${part.returned || ''}" min="0" max="${part.qty}" onchange="updateReturned(${index})" onfocus="clearZero(this)" id="returned-${index}" placeholder="0"></td>
            <td id="refund-${index}">0.00</td>
            <td><input type="checkbox" class="checkbox" onchange="toggleReturn(${index})" id="check-${index}" ${part.returned === part.qty ? 'checked' : ''}></td>
          </tr>
        `;
      });

      tableHTML += `</tbody></table>`;
      document.getElementById("tableContainer").innerHTML = tableHTML;
      calculateRefunds();
    }

    // [Rest of the functions remain exactly the same]
  </script>
</body>
</html>
