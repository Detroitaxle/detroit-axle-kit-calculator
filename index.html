<style>
  /* REMOVE ARROWS FROM NUMBER INPUTS */
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield; /* Firefox */
  }
</style>

<script>
  class KitCalculator {
    constructor() {
      this.parts = [];
      this.knownSingleItems = [
        "brake pads", "brake rotors", "brake shoes", "brake drums",
        "brake pad", "rotor", "pads", "shoes", "drums"
      ];
      this.init();
    }

    init() {
      this.bindEvents();
      this.updateSummary();
    }

    bindEvents() {
      const kitInput = document.getElementById("kitInput");
      const kitPrice = document.getElementById("kitPrice");

      kitInput.addEventListener("input", this.debounce(() => this.processInput(), 300));
      kitPrice.addEventListener("input", this.debounce(() => this.calculateRefunds(), 200));
    }

    debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    normalizeQuantity(description, quantity, partNumber) {
      const descLower = description.toLowerCase();
      if (this.knownSingleItems.some(item => descLower.includes(item))) return 1;
      if (descLower.includes("(pair)") && quantity === 1) return 2;
      if (partNumber && partNumber.toLowerCase().endsWith("x2") && quantity === 1) return 2;
      return quantity;
    }

    processInput() {
      const input = document.getElementById("kitInput").value.trim();
      if (!input) {
        this.parts = [];
        this.renderEmptyState();
        this.updateSummary();
        return;
      }

      const lines = input.split(/\n+/).filter(line => line.trim());
      this.parts = [];

      lines.forEach(line => {
        const trimmedLine = line.trim();
        if (!trimmedLine) return;

        let qty = 1, desc = "", partNum = "";

        if (trimmedLine.includes("\t")) {
          const parts = trimmedLine.split("\t");
          if (parts.length >= 3) {
            qty = parseInt(parts[0]) || 1;
            desc = parts[1].trim();
            partNum = parts[2].trim();
          }
        } else if (trimmedLine.includes("x") && (trimmedLine.includes("-") || trimmedLine.includes(":"))) {
          const xIndex = trimmedLine.indexOf("x");
          const separatorIndex = Math.max(trimmedLine.indexOf(" - "), trimmedLine.indexOf(": "));
          if (xIndex > 0 && separatorIndex > xIndex) {
            qty = parseInt(trimmedLine.substring(0, xIndex)) || 1;
            desc = trimmedLine.substring(xIndex + 1, separatorIndex).trim();
            partNum = trimmedLine.substring(separatorIndex + 2).trim();
          }
        } else {
          const words = trimmedLine.split(/\s+/);
          if (!isNaN(words[0])) {
            qty = parseInt(words[0]);
            desc = words.slice(1, -1).join(" ");
            partNum = words[words.length - 1];
          } else {
            desc = trimmedLine;
          }
        }

        qty = this.normalizeQuantity(desc, qty, partNum);

        this.parts.push({
          qty, desc, partNum, price: 0,
          returned: 0, isReturned: false
        });
      });

      if (this.parts.length > 0) {
        this.renderTable();
        this.showNotification("Parts loaded successfully!", "success");
      } else {
        this.renderEmptyState();
      }

      this.updateSummary();
    }

    renderEmptyState() {
      document.getElementById("partsContainer").innerHTML = `
        <div class="empty-state">
          <i class="fas fa-box-open"></i>
          <h3>Ready for Input</h3>
          <p>Paste your kit component list above to begin calculating refunds</p>
        </div>
      `;
    }

    renderTable() {
      let tableHTML = `
        <div class="parts-header">
          <h3><i class="fas fa-cogs"></i> Parts Breakdown</h3>
        </div>
        <table class="parts-table">
          <thead>
            <tr>
              <th>Qty</th>
              <th>Description</th>
              <th>Part Number</th>
              <th>Unit Price</th>
              <th>Returned</th>
              <th>Refund</th>
              <th>Return All</th>
            </tr>
          </thead>
          <tbody>
      `;

      this.parts.forEach((part, index) => {
        tableHTML += `
          <tr class="fade-in">
            <td><input type="number" class="input-field" value="${part.qty}" onchange="calculator.updatePart(${index}, 'qty', this.value)" min="0"></td>
            <td class="part-description">${part.desc}</td>
            <td>${part.partNum ? `<span class="part-number">${part.partNum}</span>` : '<span style="color: var(--text-muted);">â€”</span>'}</td>
            <td><input type="number" class="input-field" placeholder="0.00" onchange="calculator.updatePart(${index}, 'price', this.value)" step="0.01" min="0"></td>
            <td><input type="number" class="input-field" value="${part.returned}" onchange="calculator.updatePart(${index}, 'returned', this.value)" min="0" max="${part.qty}"></td>
            <td class="refund-value" id="refund-${index}">$0.00</td>
            <td>
              <div class="checkbox-container">
                <label class="modern-checkbox">
                  <input type="checkbox" onchange="calculator.toggleReturn(${index}, this)" ${part.isReturned ? "checked" : ""}>
                  <span class="checkbox-mark"></span>
                </label>
              </div>
            </td>
          </tr>
        `;
      });

      tableHTML += `</tbody></table>`;
      document.getElementById("partsContainer").innerHTML = tableHTML;
      this.calculateRefunds();
    }

    updatePart(index, field, value) {
      const numValue = parseFloat(value) || 0;
      this.parts[index][field] = numValue;
      if (field === "returned" && numValue > this.parts[index].qty) {
        this.parts[index].returned = this.parts[index].qty;
      }
      this.calculateRefunds();
    }

    toggleReturn(index, checkbox) {
      const returnedInput = checkbox.closest("tr").querySelector("td:nth-child(5) input");
      if (checkbox.checked) {
        this.parts[index].returned = this.parts[index].qty;
        this.parts[index].isReturned = true;
        returnedInput.value = this.parts[index].qty;
      } else {
        this.parts[index].returned = 0;
        this.parts[index].isReturned = false;
        returnedInput.value = 0;
      }
      this.calculateRefunds();
    }

    calculateRefunds() {
      if (this.parts.length === 0) return;

      const totalUndiscounted = this.parts.reduce((sum, p) => sum + (p.qty * p.price), 0);
      const kitPrice = parseFloat(document.getElementById("kitPrice").value) || totalUndiscounted;
      const discountFactor = totalUndiscounted > 0 ? (kitPrice / totalUndiscounted) : 1;

      let totalRefund = 0;
      this.parts.forEach((part, index) => {
        const discountedPrice = part.price * discountFactor;
        const refund = Math.min(part.returned, part.qty) * discountedPrice;
        totalRefund += refund;
        const refundElement = document.getElementById(`refund-${index}`);
        if (refundElement) refundElement.textContent = `$${refund.toFixed(2)}`;
      });

      this.updateSummary(totalRefund, kitPrice);
    }

    updateSummary(totalRefund = 0, kitValue = 0) {
      document.getElementById("totalParts").textContent = this.parts.length;
      document.getElementById("kitValue").textContent = `$${kitValue.toFixed(2)}`;
      document.getElementById("totalRefund").textContent = `$${totalRefund.toFixed(2)}`;
    }

    showNotification(message, type = "success") {
      const notification = document.createElement("div");
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.classList.add("show"), 100);
      setTimeout(() => {
        notification.classList.remove("show");
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }
  }

  const calculator = new KitCalculator();
</script>
